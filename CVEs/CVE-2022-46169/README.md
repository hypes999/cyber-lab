# CVE-2022-46169 — Remote Code Execution no Cacti

A CVE-2022-46169 é uma vulnerabilidade crítica no Cacti que permite execução remota de código sem autenticação. O problema resulta de validação incorreta no endpoint `remote_agent.php`, onde cabeçalhos manipuláveis são usados para decisões de autenticação e parâmetros inseguros são enviados diretamente para o sistema operativo.

---

## 1. Descrição da vulnerabilidade

### 1.1 Bypass de autenticação

O endpoint `remote_agent.php` foi concebido para ser acedido apenas por pollers autorizados.
O Cacti usa `remote_client_authorized()` para validar o cliente com base no IP obtido por `get_client_addr()`.

Este mecanismo aceita cabeçalhos controláveis pelo atacante, como:

* `X-Forwarded-For`

Ao definir um IP interno, como `127.0.0.1`, o atacante é tratado como um poller legítimo.

### 1.2 Injeção de comandos

Após contornar a autenticação, parâmetros como `poller_id` são utilizados sem sanitização adequada.
O valor é colocado em funções do sistema operativo, permitindo:

* Injeção de comandos
* Execução remota de código com privilégios do serviço web (`www-data`)

Resultado: **RCE sem autenticação**.

---

## 2. Cadeia de exploração

### Passo 1 — Acesso inicial

Foram enviados pedidos HTTP manipulados para `remote_agent.php`, incluindo cabeçalhos forjados.
O sistema aceitou o pedido sem autenticação.

### Passo 2 — Execução remota

Comandos arbitrários foram executados.
Foi obtida uma shell remota via netcat, confirmando RCE.

### Passo 3 — Pós-exploração

* Enumeração do sistema de ficheiros
* Acesso a diretórios internos da aplicação
* Identificação de ficheiros sensíveis
  Mostrado impacto real e controlo total da aplicação.

---

## 3. Impacto

A exploração permite:

* Execução remota de código sem autenticação
* Compromisso total da aplicação Cacti
* Acesso e exfiltração de dados
* Persistência no sistema
* Possibilidade de pivot para a rede interna

**Classificação:** Crítica — CVSS 9.8

---

## 4. Deteção e defesa

### Regra de deteção

Foi criada uma regra específica para identificar tentativas de exploração desta CVE e integrada no Suricata.

### Análise forense

Foram identificados:

* endpoint abusado
* parâmetros modificados
* IP do atacante
* artefactos deixados após exploração

Os logs permitem reconstruir o ataque de forma completa.

---

## 5. Mitigação

Ações recomendadas:

* Atualizar para versões corrigidas do Cacti
* Restringir totalmente o acesso a `remote_agent.php`
* Evitar confiar em cabeçalhos para autenticação
* Validar rigorosamente todos os inputs
* Monitorizar atividade com IDS/SIEM

---

## 6. Notas

Esta vulnerabilidade mostra como uma falha de lógica e confiança indevida em cabeçalhos de cliente pode resultar num RCE crítico sem autenticação.
